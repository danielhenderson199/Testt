#!/bin/bash

set -e

# VMware download link for Workstation Pro (v17.5.0)
VMWARE_URL="https://download3.vmware.com/software/wkst/file/VMware-Workstation-Full-17.5.0-22583795.x86_64.bundle"
BUNDLE_NAME="VMware-Workstation-Full-17.5.0-22583795.x86_64.bundle"

# Function to check if the script is run as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "‚ùå Please run this script as root (use sudo)."
        exit 1
    fi
}

# Try to install the correct Linux headers
install_headers() {
    KERNEL_VERSION=$(uname -r)
    echo "üîç Kernel version detected: $KERNEL_VERSION"

    echo "üì¶ Attempting to install kernel headers for $KERNEL_VERSION..."
    if apt-get install -y "linux-headers-$KERNEL_VERSION"; then
        echo "‚úÖ Kernel headers installed successfully."
    else
        echo "‚ö†Ô∏è Could not install linux-headers-$KERNEL_VERSION"
        echo "üëâ Trying generic headers instead..."
        apt-get install -y linux-headers-generic || {
            echo "‚ùå Failed to install linux headers. You may be on a custom kernel."
            echo "‚û°Ô∏è Manual fix: Download and install matching headers from your distro's kernel repo."
            exit 1
        }
    fi
}

# Install required build dependencies
install_dependencies() {
    echo "üîß Installing required packages..."
    apt update
    apt install -y build-essential dkms wget
    install_headers
}

# Download the VMware bundle
download_vmware() {
    echo "‚¨áÔ∏è Downloading VMware Workstation Pro..."
    wget -O "$BUNDLE_NAME" "$VMWARE_URL"
    chmod +x "$BUNDLE_NAME"
}

# Run the installer
install_vmware() {
    echo "üöÄ Running the VMware installer..."
    ./"$BUNDLE_NAME" --required --eulas-agreed
}

# Final message
post_install() {
    if command -v vmware &>/dev/null; then
        echo "‚úÖ VMware Workstation Pro installed successfully!"
    else
        echo "‚ö†Ô∏è VMware may not be in PATH or the install may have failed."
    fi
}

# Run all steps
check_root
install_dependencies
download_vmware
install_vmware
post_install
