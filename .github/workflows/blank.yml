name: VM-Server

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Name for Tailscale node'
        required: true
        default: 'windowsnode'

jobs:
  setup-connection:
    runs-on: windows-2022
    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      VM_USERNAME: ${{ secrets.VM_USERNAME }}
      VM_PASSWORD: ${{ secrets.VM_PASSWORD }}

    steps:
      - name: Create Local Admin User
        shell: pwsh
        run: |
          net user "$env:VM_USERNAME" "$env:VM_PASSWORD" /add
          net localgroup "Administrators" "$env:VM_USERNAME" /add
          net localgroup "Remote Desktop Users" "$env:VM_USERNAME" /add

      - name: Install Tailscale
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup.exe" -OutFile "tailscale-setup.exe"
          Start-Process .\tailscale-setup.exe -Wait

      - name: Start Tailscale
        shell: pwsh
        run: |
          tailscale up --authkey "$env:TAILSCALE_AUTHKEY" --hostname "${{ github.event.inputs.vm_name }}" --accept-routes
          $tailscaleIp = (tailscale ip -4)[0]
          "TAILSCALE_IP=$tailscaleIp" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Keep Workflow Alive
        shell: pwsh
        run: |
          Start-Sleep -Seconds 21600
