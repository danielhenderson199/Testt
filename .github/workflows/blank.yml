name: VM-Server

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Name for Tailscale node'
        required: true
        default: 'windowsnode'

jobs:
  setup-connection:
    runs-on: windows-2022
    env:
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      VM_USERNAME: ${{ secrets.VM_USERNAME }}
      VM_PASSWORD: ${{ secrets.VM_PASSWORD }}

    steps:
      - name: Notify Start
        run: |
          curl -X POST "https://discord.com/api/v10/channels/$env:DISCORD_CHANNEL_ID/messages" ^
            -H "Authorization: Bot $env:DISCORD_BOT_TOKEN" ^
            -H "Content-Type: application/json" ^
            -d "{\"content\":\"üöÄ **Workflow Started**\nüîπ Node: \`${{ github.event.inputs.vm_name }}\`\"}"

      - name: Create Local Admin User
        run: |
          net user "$env:VM_USERNAME" "$env:VM_PASSWORD" /add
          net localgroup "Administrators" "$env:VM_USERNAME" /add
          net localgroup "Remote Desktop Users" "$env:VM_USERNAME" /add

          curl -X POST "https://discord.com/api/v10/channels/$env:DISCORD_CHANNEL_ID/messages" ^
            -H "Authorization: Bot $env:DISCORD_BOT_TOKEN" ^
            -H "Content-Type: application/json" ^
            -d "{\"content\":\"üë§ User \`$env:VM_USERNAME\` created and added to **Administrators** and **Remote Desktop Users**.\"}"

      - name: Install Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup.exe" -OutFile "tailscale-setup.exe"
          Start-Process .\tailscale-setup.exe -Wait

      - name: Start Tailscale
        run: |
          tailscale up --authkey $env:TAILSCALE_AUTHKEY --hostname "${{ github.event.inputs.vm_name }}" --accept-routes
          $tailscaleIp = (tailscale ip -4)[0]
          echo "TAILSCALE_IP=$tailscaleIp" | Out-File -FilePath $env:GITHUB_ENV -Append

          curl -X POST "https://discord.com/api/v10/channels/$env:DISCORD_CHANNEL_ID/messages" ^
            -H "Authorization: Bot $env:DISCORD_BOT_TOKEN" ^
            -H "Content-Type: application/json" ^
            -d "{\"content\":\"üîå Tailscale connected: \`$tailscaleIp\`\"}"

      - name: Keep Workflow Alive
        run: |
          curl -X POST "https://discord.com/api/v10/channels/$env:DISCORD_CHANNEL_ID/messages" ^
            -H "Authorization: Bot $env:DISCORD_BOT_TOKEN" ^
            -H "Content-Type: application/json" ^
            -d "{\"content\":\"‚è≥ Holding workflow for 6 hours...\"}"

          powershell -Command "Start-Sleep -Seconds 21600"
